name: Deploy to QA

on:
  push:
    branches: [qa]
  workflow_dispatch:
    inputs:
      action:
        description: "Deployment action"
        required: true
        default: "deploy"
        type: choice
        options:
          - plan
          - deploy
          - destroy

env:
  TF_VERSION: "1.6.0"
  AWS_REGION: "us-east-1"
  ENVIRONMENT: "qa"

jobs:
  # =============================================================================
  # Build and Push Docker Images
  # =============================================================================
  build:
    name: ðŸ³ Build Images
    runs-on: ubuntu-latest
    if: github.event.inputs.action != 'destroy'

    strategy:
      matrix:
        service:
          - api-gateway
          - core-service
          - shared-service
          - inventory-service
          - audit-service
          - mobile-bff
          - geo-tracker
          - analytics-engine

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ” Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ðŸ—ï¸ Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: apps/${{ matrix.service }}/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/sima-${{ matrix.service }}:qa
            ${{ secrets.DOCKERHUB_USERNAME }}/sima-${{ matrix.service }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # =============================================================================
  # Check Existing Infrastructure
  # =============================================================================
  check-infra:
    name: ðŸ” Check Infrastructure
    runs-on: ubuntu-latest
    needs: build
    if: always() && (needs.build.result == 'success' || needs.build.result == 'skipped')

    outputs:
      vpc_exists: ${{ steps.check.outputs.vpc_exists }}
      rds_exists: ${{ steps.check.outputs.rds_exists }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ðŸ” Run infrastructure check
        id: check
        run: |
          chmod +x ./infrastructure/scripts/check-infra.sh
          ./infrastructure/scripts/check-infra.sh qa

  # =============================================================================
  # Terraform Deployment
  # =============================================================================
  terraform:
    name: ðŸš€ Terraform ${{ github.event.inputs.action || 'deploy' }}
    runs-on: ubuntu-latest
    needs: check-infra
    environment: qa

    defaults:
      run:
        working-directory: infrastructure/terraform/environments/qa

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: ðŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ðŸ“‹ Terraform Format Check
        run: terraform fmt -check -recursive
        continue-on-error: true

      - name: ðŸ”„ Terraform Init
        run: terraform init

      - name: âœ… Terraform Validate
        run: terraform validate

      - name: ðŸ“ Terraform Plan
        if: github.event.inputs.action != 'destroy'
        run: terraform plan -out=qa.tfplan -no-color
        env:
          TF_VAR_db_password: ${{ secrets.DB_PASSWORD }}

      - name: ðŸš€ Terraform Apply
        if: github.event.inputs.action == 'deploy' || (github.event_name == 'push' && github.ref == 'refs/heads/qa')
        run: terraform apply -auto-approve qa.tfplan

      - name: ðŸ’¥ Terraform Destroy
        if: github.event.inputs.action == 'destroy'
        run: terraform destroy -auto-approve
        env:
          TF_VAR_db_password: ${{ secrets.DB_PASSWORD }}

      - name: ðŸ“Š Save Terraform Outputs
        if: github.event.inputs.action != 'destroy'
        id: outputs
        run: |
          echo "alb_url=$(terraform output -raw alb_url)" >> $GITHUB_OUTPUT
          echo "rds_endpoint=$(terraform output -raw rds_endpoint)" >> $GITHUB_OUTPUT
          echo "redis_endpoint=$(terraform output -raw redis_endpoint)" >> $GITHUB_OUTPUT

  # =============================================================================
  # Deploy Containers
  # =============================================================================
  deploy-containers:
    name: ðŸ“¦ Deploy Containers
    runs-on: ubuntu-latest
    needs: terraform
    if: github.event.inputs.action != 'destroy' && github.event.inputs.action != 'plan'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ðŸ“¦ Deploy containers to EC2
        run: |
          chmod +x ./infrastructure/scripts/deploy-containers.sh
          ./infrastructure/scripts/deploy-containers.sh qa
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}

  # =============================================================================
  # Health Check
  # =============================================================================
  health-check:
    name: ðŸ¥ Health Check
    runs-on: ubuntu-latest
    needs: deploy-containers
    if: github.event.inputs.action != 'destroy' && github.event.inputs.action != 'plan'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ðŸ¥ Run health checks
        run: |
          chmod +x ./infrastructure/scripts/health-check.sh
          ./infrastructure/scripts/health-check.sh qa

  # =============================================================================
  # Summary
  # =============================================================================
  summary:
    name: ðŸ“Š Deployment Summary
    runs-on: ubuntu-latest
    needs: [build, terraform, deploy-containers, health-check]
    if: always()

    steps:
      - name: ðŸ“Š Generate Summary
        run: |
          echo "## ðŸš€ QA Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Step | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build Images | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Terraform | ${{ needs.terraform.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy Containers | ${{ needs.deploy-containers.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Health Check | ${{ needs.health-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Triggered by: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
